name: Show release commits (debug)

on:
  create:
    tags: true

jobs:
  show_release_commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # potrzebne do pracy z tagami i historiÄ… commitÃ³w

      - name: Show commits between two most recent tags in same series (with debug)
        run: |
          set -euo pipefail

          echo "âœ… Start skryptu"

          # WyciÄ…gamy nazwÄ™ nowego taga (np. core-2025.73.0)
          echo "ğŸ” GITHUB_REF: $GITHUB_REF"
          NEW_TAG="${GITHUB_REF#refs/tags/}"
          echo "ğŸ†• Nowy tag: $NEW_TAG"

          # Rozpoznajemy prefiks serii (np. core-2025.)
          if [[ "$NEW_TAG" =~ ^(core-[0-9]+\.) ]]; then
            SERIES_PREFIX="${BASH_REMATCH[1]}"
            echo "ğŸ“¦ Rozpoznany prefiks serii: $SERIES_PREFIX"
          else
            echo "âŒ Tag '$NEW_TAG' nie pasuje do wzorca 'core-ROK.'. Przerywam."
            exit 1
          fi

          # Pobieramy i wyÅ›wietlamy wszystkie tagi w tej serii (debug)
          echo "ğŸ“„ Pobieram listÄ™ tagÃ³w w serii '$SERIES_PREFIX*'..."
          mapfile -t SERIES_TAGS < <(git tag --list "${SERIES_PREFIX}*" | sort -rV)

          echo "ğŸ“‘ Wszystkie tagi w serii (posortowane malejÄ…co):"
          for tag in "${SERIES_TAGS[@]}"; do
            echo "   - $tag"
          done

          # Szukamy indeksu aktualnego taga
          echo "ğŸ” Szukam indeksu tagu '$NEW_TAG' na liÅ›cie..."
          CURRENT_INDEX=-1
          for i in "${!SERIES_TAGS[@]}"; do
            echo "   ğŸ” PorÃ³wnujÄ™: ${SERIES_TAGS[$i]}"
            if [[ "${SERIES_TAGS[$i]}" == "$NEW_TAG" ]]; then
              CURRENT_INDEX=$i
              echo "   âœ… Trafiony indeks: $CURRENT_INDEX"
              break
            fi
          done

          # ObsÅ‚uga bÅ‚Ä™dÃ³w: nie znaleziono taga
          if (( CURRENT_INDEX == -1 )); then
            echo "âŒ Nie znaleziono tagu '$NEW_TAG' na liÅ›cie. KoÅ„czÄ™."
            exit 1
          fi

          # Sprawdzenie, czy jest poprzedni tag
          if (( CURRENT_INDEX + 1 >= ${#SERIES_TAGS[@]} )); then
            echo "â„¹ï¸ Brak starszego taga w tej serii â€” nie ma czego porÃ³wnaÄ‡."
            exit 0
          fi

          # Pobieramy poprzedni tag
          PREVIOUS_TAG="${SERIES_TAGS[$((CURRENT_INDEX + 1))]}"
          echo "â¬…ï¸ Poprzedni tag w serii: $PREVIOUS_TAG"

          # WyÅ›wietlenie porÃ³wnania tagÃ³w
          echo "ğŸ§¾ Commity pomiÄ™dzy:"
          echo "   ğŸ”¹ $PREVIOUS_TAG"
          echo "   ğŸ”¸ $NEW_TAG"
          echo

          # Pokazujemy commity
          echo "ğŸ“œ Commity miÄ™dzy tagami:"
          git log --pretty=format:'%h %s' "$PREVIOUS_TAG..$NEW_TAG"

          echo "âœ… Koniec skryptu"
